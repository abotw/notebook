# 有限状态机 FSM（Finite State Machine）

## 基本定义

**有限状态机（FSM）**是一种具有有限个状态、状态之间有条件转移的数学模型，广泛用于**时序逻辑电路设计、软件建模、编译原理、网络协议等**领域。  
FSM 根据输入和当前状态决定**下一个状态**与（可能的）**输出**。

---

## FSM 的基本组成

1. **状态集合（States）**：系统可能处于的所有状态。
    
2. **输入集合（Inputs）**：影响状态转移的外部信号。
    
3. **输出集合（Outputs）**：系统根据当前状态（和输入）产生的结果。
    
4. **状态转移函数**：定义状态之间的转移关系。
    
5. **输出函数**：定义状态（和输入）对应的输出。
    
6. **初始状态**：系统启动时的默认状态。
    

---

## FSM 分类：Moore 与 Mealy

|特性|Moore 型 FSM|Mealy 型 FSM|
|---|---|---|
|输出依赖|仅当前状态|当前状态 + 当前输入|
|输出更新时机|状态改变时|输入改变时即可更新输出|
|状态数|相对较多|相对较少|
|设计复杂度|较低（逻辑独立，容易时序分析）|稍高（更敏感于输入）|

---

## 示例：检测101序列的 FSM（Mealy 型）

> 目标：检测输入串中是否出现“101”，若检测到立即输出1，否则输出0。

### 状态定义

- S0：初始状态，未检测到1
    
- S1：检测到1
    
- S2：检测到10
    

### 状态转移图（简要）

```
输入: x ∈ {0,1}，输出: z ∈ {0,1}

S0 --1/0--> S1 --0/0--> S2 --1/1--> S1  
 ↑         ↓         ↘
0/0       1/0        0/0
 |         |           |
S0       S1          S0
```

---

## FSM 设计流程

1. **明确功能**：定义行为需求，识别关键序列/模式。
    
2. **定义状态**：每个状态需具有逻辑含义。
    
3. **绘制状态图**：包括转移条件与输出。
    
4. **建立状态转移表/编码**。
    
5. **选择 FSM 类型（Moore/Mealy）**。
    
6. **实现 FSM（硬件语言如 Verilog 或软件状态机）**。
    

---

## 相关领域联系

- **编译原理**：词法分析器用 DFA 实现，是 FSM 的应用。
    
- **网络通信**：TCP 状态机、协议握手流程建模。
    
- **人工智能**：有限状态行为模型（如敌人 AI 巡逻状态机）。
    
- **游戏开发**：角色行为控制系统（状态驱动）通常采用 FSM。
    

---

## Verilog 硬件实现（简要）

```verilog
// 状态编码
parameter S0 = 2'b00, S1 = 2'b01, S2 = 2'b10;

reg [1:0] state, next_state;

always @(posedge clk or posedge rst) begin
    if (rst)
        state <= S0;
    else
        state <= next_state;
end

always @(*) begin
    case (state)
        S0: next_state = (in == 1) ? S1 : S0;
        S1: next_state = (in == 0) ? S2 : S1;
        S2: next_state = (in == 1) ? S1 : S0;
        default: next_state = S0;
    endcase
end

assign out = (state == S2 && in == 1) ? 1 : 0;  // Mealy 输出
```

---

## 状态最小化与优化技巧

- **合并等价状态**：判断是否存在行为完全一致的状态（等价类）。
    
- **选择合适的状态编码方式**：
    
    - Binary 编码（适合少量状态）
        
    - One-hot 编码（适合 FPGA 实现）
        
    - Gray 编码（减少切换抖动）
        

---

## 常见陷阱与注意事项

- 状态转移图不完备：未涵盖所有输入组合 → 应加 default 分支。
    
- 输出逻辑不明确：应明确 Moore/Mealy 类型，避免混用。
    
- 异步复位/同步复位：视芯片平台与设计需求而定。
    