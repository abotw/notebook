# 堆栈寄存器（SP）

## 📌 简介

**堆栈寄存器（Stack Pointer，SP）**用于指向当前**栈顶位置**，是函数调用、局部变量分配、保存返回地址和上下文切换的核心寄存器之一。

## 🧠 核心要点

|要点|说明|
|---|---|
|功能|指向栈顶地址，支持**入栈/出栈操作**|
|数据结构|与**栈（Stack）**数据结构绑定，LIFO（后进先出）|
|改变方向|栈通常向低地址增长（如 x86），SP 减小表示压栈|
|寄存器命名|常见：`SP`（ARM/RISC-V）、`ESP` / `RSP`（x86/x86-64）|
|类型|属于 CPU 的**通用寄存器**之一，但具有特殊用途|

## 🔍 经典使用场景

### 1. **函数调用与返回**

- **压栈：**保存返回地址、局部变量、被调用函数的参数等。
    
- **出栈：**恢复现场，返回调用者。
    

```asm
; x86 汇编示例
CALL func       ; 压入返回地址，跳转到 func
RET             ; 从 SP 弹出返回地址，跳回调用点
```

### 2. **中断处理**

- 中断发生时，CPU 自动将部分寄存器值压栈（如 PC、标志位），  
    利用 SP 保存当前上下文，便于返回时恢复。
    

### 3. **线程切换**

- 多线程切换时，操作系统会保存/恢复线程的 SP，保证每个线程有独立的栈空间。
    

## 🧩 操作细节与注意事项

|操作|行为（假设栈向低地址增长）|
|---|---|
|`PUSH` 指令|SP ← SP - n；Mem[SP] ← 数据|
|`POP` 指令|数据 ← Mem[SP]；SP ← SP + n|
|溢出（Stack Overflow）|栈越界覆盖其他内存，可能导致程序崩溃|

### ARM 示例（C 调用约定 AAPCS）

```asm
PUSH {R4-R7, LR}   ; 保存被调用者保存寄存器和返回地址
POP  {R4-R7, PC}   ; 恢复寄存器并返回（PC = LR）
```

## 🔗 融会贯通

- **与程序计数器（PC）协同工作：**函数调用时将 PC 值压栈，返回时通过 `RET` 指令从 SP 弹出 PC 值恢复。
    
- **与帧指针（FP/EBP）关系：**SP 常与帧指针配合使用以管理函数栈帧。FP 固定指向当前函数栈底，SP 灵活变化。
    
- **与虚拟内存结合：**栈通常映射为独立页（如 Linux 的 `stack` 段），页表控制栈大小及权限。
    

## 💡 小贴士

- 栈初始化由操作系统负责，通常从高地址向下分配。
    
- 在 C 语言中递归过深易导致**栈溢出**，可通过 `ulimit -s` 查看或调整栈大小。
    
- 栈空间通常有限，**大数组/缓冲区应分配到堆（heap）**上。
    

## 📚 延伸阅读

- 《深入理解计算机系统》（CSAPP）第 3 章：程序的机器级表示
    
- Linux 源码中线程栈初始化位置：`start_thread()`、`copy_thread()`
    
- RISC-V 指令手册：`SP` 的栈操作规范与调用约定