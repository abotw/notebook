# 竞态条件（Race Condition）

## 概念简述

- **竞态条件**：多个进程或线程在**并发访问共享资源**时，**执行顺序不确定**，从而导致**程序行为不可预测**或**错误结果**的现象。
    
- 产生条件：
    
    1. **并发执行**
        
    2. **共享资源**
        
    3. **缺乏适当同步**
        

---

## 核心要点

- **本质**：多个线程/进程“竞争”资源，且对执行顺序的依赖导致错误。
    
- **常见后果**：数据不一致、死锁、程序崩溃、安全漏洞。
    
- **典型资源**：变量、文件、缓冲区、I/O 设备、临界区等。
    

---

## 经典案例

### 1. **银行账户转账问题**

两个线程同时读取余额100元，一个扣款30元，一个扣款80元，**均成功通过检查**（余额≥所需），最终余额变为-10，违背业务规则。

### 2. **UNIX/Linux 文件权限检查漏洞**

早期某些程序先检查某文件是否可访问（`access()`），再打开文件（`open()`）。攻击者可在二者之间替换文件，实现**TOCTTOU（检查与使用间时序漏洞）**。

### 3. **共享变量自增**

```c
// 假设 counter 初始为 0
counter++;
```

拆解为三步：读 → 加1 → 写。两个线程同时执行可能都读到 0，最后写入都是 1，丢失一次加法。

---

## 常见防范方法

|方法|描述|
|---|---|
|原子操作|使用硬件或语言层支持的不可中断操作|
|互斥锁（mutex）|加锁保证同一时刻仅一个线程访问关键区域|
|信号量（semaphore）|控制资源访问数量，常用于资源池等情况|
|屏障（barrier）|等待所有线程到达某点后再继续执行|
|死锁预防|谨慎设计锁顺序，避免相互等待|

---

## 与其他垂直领域的关联

- **操作系统**：进程调度、线程同步、临界区管理等。
    
- **嵌入式系统**：由于资源紧张，竞态条件尤为危险，常用中断屏蔽或锁机制保护共享数据。
    
- **网络编程**：并发连接处理（如多线程HTTP服务器）需小心数据同步。
    
- **软件测试**：竞态条件往往是**间歇性 bug**，需使用工具如 ThreadSanitizer、Helgrind 等检测。
    

---

## 思维导图式总结

- 竞态条件：并发 + 共享 + 同步缺失  
    ↓  
    错误行为 → 崩溃 / 漏洞 / 数据错乱  
    ↓  
    对策：加锁 / 原子操作 / 严格线程管理
    

---

是否需要我为你生成一个竞态条件的思维导图图像？